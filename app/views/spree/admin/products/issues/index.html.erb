<%= render partial: 'spree/admin/shared/product_sub_menu' %>

<%= render partial: 'spree/admin/shared/product_tabs', locals: { current: 'Issues' } %>

<% content_for :page_actions do %>
  <li id="new_issue_link">
    <%= button_link_to Spree.t(:new_issue), new_admin_magazine_issue_url(@magazine), { icon: 'plus', id: 'admin_new_issue' } %>
  </li>
<% end if can?(:create, Spree::Issue) %>

<h1><%= Spree.t(:listing_issues) %></h1>

<div data-hook="active_subscribers">
  <br>
  <h4>
    <%= number_with_delimiter(Spree::Subscription.where(magazine: @magazine).eligible_for_shipping.count) %> Active Subscribers <span data-hook="admin_magazine_active_subscribers_csv"><%= link_to_with_icon 'list', Spree.t(:csv), admin_magazine_path(@magazine, format: :csv) %></span>
  </h4>
  <br>
</div>

<table class="index" id="listing_issues">
  <thead>
    <tr>
      <th data-hook="admin_issues_index_header_name"><%= t(:name, scope: 'activerecord.attributes.spree/issue') %></th>
      <th data-hook="admin_issues_index_header_num_subscribers"><%= Spree.t(:recipients) %></th>
      <th data-hook="admin_issues_index_header_shipped_at"><%= t(:shipped_at, scope: 'activerecord.attributes.spree/issue') %></th>
      <th data-hook="admin_issues_index_header_actions" class="actions"></th>
    </tr>
  </thead>
  <tbody>
    <% @issues.each do |issue| %>
      <tr>
        <td data-hook="admin_issues_index_row_name"><%= link_to issue.name, admin_magazine_issue_url(@magazine, issue) %></td>
        <td data-hook="admin_issues_index_row_subscribers">
          <% case issue.state.to_sym %>
          <% when :shipped %>
            <%= pluralize(number_with_delimiter(issue.shipped_issues.size), Spree.t(:recipient)) %>
          <% when :unshipped %>
            <%= pluralize(number_with_delimiter(@magazine.subscriptions.eligible_for_shipping_issue(issue).size), Spree.t(:eligible_recipient)) %>
          <% when :ship_pending %>
            <i><%= pluralize(number_with_delimiter(issue.shipped_issues.size), Spree.t(:issues)) %> shipped so far</i>
          <% when :unship_pending %>
            <i><%= pluralize(number_with_delimiter(issue.shipped_issues.size), Spree.t(:issues)) %> remaining to unship</i>
          <% else %>
            <%= "STATE: " + issue.state %>
          <% end %>
          <% case issue.state.to_sym %>
            <% when :shipped, :unshipped %>
              <br>
              <span data-hook="admin_issues_index_row_subscribers_csv"><%= link_to_with_icon 'list', Spree.t(:csv), admin_magazine_issue_path(@magazine, issue, format: :csv) %></span>
          <% end %>
        </td>
        <td data-hook="admin_issues_index_row_shipped_at">
          <% case issue.state.to_sym %>
            <% when :shipped %>
              <%= issue.shipped_at.to_s(:db) %>
            <% when :unshipped %>
              <%= Spree.t(:issue_not_shipped) %>
            <% when :ship_pending %>
              <i>Shipment Pending</i>
            <% when :unship_pending %>
              <i>Unship Pending</i>
          <% end %>
          </td>
        <td class="actions" data-hook="admin_issues_index_row_actions">
          <%= link_to_with_icon :truck, Spree.t(:ship), admin_magazine_issue_ship_path(@magazine, issue), {no_text: true, confirm: Spree.t(:confirm_ship)} if issue.can_ship? %>
          <%= link_to_with_icon :history, Spree.t(:unship), admin_magazine_issue_unship_path(@magazine, issue), {no_text: true, confirm: Spree.t(:confirm_unship)} if issue == @issues.shipped.order('shipped_at DESC').first %>
          <%= link_to_with_icon :edit,  Spree.t(:edit), edit_admin_magazine_issue_url(@magazine, issue), no_text: true, class: 'edit' if issue.unshipped? %>
          <%= link_to_with_icon :trash,  Spree.t(:delete), admin_magazine_issue_url(@magazine, issue), method: :delete, no_text: true if issue.unshipped? %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
